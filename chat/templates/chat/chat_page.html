<!DOCTYPE html>
<html>
<head>
    <title>Chat | {{ room_name }}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'chat/style.css' %}">
</head>
<body>
    <div class="chat-container">
        <header>
            <div class="user-info">
                <span>Místnost: <b>{{ room_name }}</b> | Uživatel: {{ request.user.username }}</span>
                <form method="post" action="{% url 'logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="logout-button">Odhlásit</button>
                </form>
            </div>
        </header>

        <div class="chat-window">
            <div id="chat-log">
                {% for message in messages %}
                    <div><b>{{ message.author.username }}</b>: {{ message.content }}</div>
                {% endfor %}
            </div>
            <div class="message-input-area">
                <input id="chat-message-input" type="text" placeholder="Napište zprávu a stiskněte Enter...">
                <button id="chat-message-submit">Odeslat</button>
            </div>
        </div>
    </div>

    {{ room_name|json_script:"room-name-json" }}

    <script>
        const roomName = JSON.parse(document.getElementById('room-name-json').textContent);
        const chatLog = document.querySelector('#chat-log');
        const messageInput = document.querySelector('#chat-message-input');

        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<b>${data.username}</b>: ${data.message}`;
            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        messageInput.focus();
        messageInput.onkeyup = function(e) {
            if (e.key === 'Enter') {
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            if (messageInput.value.trim() !== '') {
                chatSocket.send(JSON.stringify({
                    'message': messageInput.value
                }));
                messageInput.value = '';
            }
        };

        chatLog.scrollTop = chatLog.scrollHeight;
    </script>
</body>
</html>