{% extends 'chat/base.html' %}
{% load static %}

{% block content %}
<form style="display:none;">{% csrf_token %}</form>

<div class="main-view-container">
    <div class="view-switcher">
        <button id="show-chat-btn" class="active">Chat</button>
        <button id="show-canvas-btn">Plátno</button>
    </div>

    <div id="chat-view" class="view active">
        <div class="chat-container">
            <div class="chat-window">
                <div id="chat-log">
                    {% now "d.m.Y" as today_date %}
                    {% for message in messages %}
                        <div>
                            <span class="message-time">
                                {% if message.timestamp|date:"d.m.Y" == today_date %}
                                    {{ message.timestamp|date:"H:i" }}
                                {% else %}
                                    {{ message.timestamp|date:"d.m.Y" }}
                                {% endif %}
                            </span>
                            <b>{{ message.author.username }}</b>: 
                            <span>{{ message.content }}</span>
                        </div>
                    {% endfor %}
                </div>
                <div class="message-input-area">
                    <input id="chat-message-input" type="text" placeholder="Napište zprávu a stiskněte Enter...">
                    <button id="chat-message-submit">Odeslat</button>
                </div>
            </div>
        </div>
    </div>

    <div id="canvas-view" class="view">
        <canvas id="drawing-canvas" width="800" height="550"></canvas>
        <div style="text-align: center; margin-top: 10px;">
            <button id="clear-canvas-btn" class="logout-button">Vymazat plátno</button>
        </div>
    </div>
</div>

{{ room_name|json_script:"room-name-json" }}
{{ canvas_content|default_if_none:"null"|json_script:"canvas-content-json" }}
<script>
    // --- Základní proměnné ---
    const roomName = JSON.parse(document.getElementById('room-name-json').textContent);
    const initialCanvasContent = JSON.parse(document.getElementById('canvas-content-json').textContent);
    const chatLog = document.querySelector('#chat-log');
    const messageInput = document.querySelector('#chat-message-input');
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(
        protocol + window.location.host + '/ws/chat/' + roomName + '/'
    );

    // --- Logika pro textový chat ---
    messageInput.focus();
    messageInput.onkeyup = function(e) {
        if (e.key === 'Enter') { document.querySelector('#chat-message-submit').click(); }
    };
    document.querySelector('#chat-message-submit').onclick = function(e) {
        if (messageInput.value.trim() !== '') {
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': messageInput.value
            }));
            messageInput.value = '';
        }
    };

    // --- Logika pro přepínání pohledů ---
    const showChatBtn = document.getElementById('show-chat-btn');
    const showCanvasBtn = document.getElementById('show-canvas-btn');
    const chatView = document.getElementById('chat-view');
    const canvasView = document.getElementById('canvas-view');

    showChatBtn.addEventListener('click', () => {
        chatView.style.display = 'block';
        canvasView.style.display = 'none';
        showChatBtn.classList.add('active');
        showCanvasBtn.classList.remove('active');
    });
    showCanvasBtn.addEventListener('click', () => {
        canvasView.style.display = 'block';
        chatView.style.display = 'none';
        showCanvasBtn.classList.add('active');
        showChatBtn.classList.remove('active');
    });
    canvasView.style.display = 'none';

    // --- Logika pro kreslení na plátno ---
    const canvas = document.getElementById('drawing-canvas');
    const context = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Načtení uložené kresby při startu
    if (initialCanvasContent) {
        const image = new Image();
        image.onload = function() {
            context.drawImage(image, 0, 0);
        };
        image.src = initialCanvasContent;
    }

    function draw(x, y, prevX, prevY) {
        context.strokeStyle = '#000000';
        context.lineWidth = 3;
        context.lineJoin = 'round';
        context.lineCap = 'round';
        context.beginPath();
        context.moveTo(prevX, prevY);
        context.lineTo(x, y);
        context.stroke();
    }

    function saveCanvasState() {
        const dataURL = canvas.toDataURL();
        // Ujistíme se, že máme CSRF token
        const csrftoken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        fetch(`/save-canvas/${roomName}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({'content': dataURL})
        });
    }

    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const currentX = e.offsetX;
        const currentY = e.offsetY;
        draw(currentX, currentY, lastX, lastY);
        chatSocket.send(JSON.stringify({
            'type': 'drawing', 'x': currentX, 'y': currentY, 'lastX': lastX, 'lastY': lastY
        }));
        [lastX, lastY] = [currentX, currentY];
    });

    canvas.addEventListener('mouseup', () => {
        if (isDrawing) {
            isDrawing = false;
            saveCanvasState();
        }
    });
    canvas.addEventListener('mouseout', () => {
        if (isDrawing) {
            isDrawing = false;
            saveCanvasState();
        }
    });

    // --- Logika pro mazání plátna ---
    const clearCanvasBtn = document.getElementById('clear-canvas-btn');
    function clearCanvas() {
        context.fillStyle = '#FFFFFF';
        context.fillRect(0, 0, canvas.width, canvas.height);
    }
    clearCanvasBtn.addEventListener('click', () => {
        clearCanvas();
        saveCanvasState();
        chatSocket.send(JSON.stringify({'type': 'clear_canvas'}));
    });

    // --- Hlavní funkce pro zpracování VŠECH zpráv z WebSocketu (OPRAVENO) ---
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === 'chat_message') {
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<span class="message-time">${data.timestamp}</span> <b>${data.username}</b>: <span>${data.message}</span>`;
            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;
        } else if (data.type === 'drawing') {
            draw(data.x, data.y, data.lastX, data.lastY);
        } else if (data.type === 'clear_canvas') {
            clearCanvas();
        }
    };
    
    chatLog.scrollTop = chatLog.scrollHeight;
</script>
{% endblock %}
