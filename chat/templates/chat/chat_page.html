{% extends 'chat/base.html' %}
{% load static %}

{% block content %}
<form style="display:none;">{% csrf_token %}</form>

<div class="main-view-container">
    <div class="view-switcher">
        <button id="show-chat-btn" class="active">Chat</button>
        <button id="show-canvas-btn">Pl치tno</button>
    </div>

    <div id="chat-view" class="view active">
        <div class="chat-layout">
            <div class="chat-container">
                <div class="chat-window">
                    <div id="chat-log">
                        {% now "d.m.Y" as today_date %}
                        {% for message in messages %}
                            <div>
                                <span class="message-time">
                                    {% if message.timestamp|date:"d.m.Y" == today_date %}{{ message.timestamp|date:"H:i" }}{% else %}{{ message.timestamp|date:"d.m.Y" }}{% endif %}
                                </span>
                                <b>{{ message.author.username }}</b>: 
                                <span>{{ message.content }}</span>
                            </div>
                        {% endfor %}
                    </div>
                    <div id="typing-indicator"></div>
                    <div class="message-input-area">
                        <input id="chat-message-input" type="text" placeholder="Napi코te zpr치vu a stiskn캩te Enter...">
                        <button id="chat-message-submit">Odeslat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="canvas-view" class="view">
        <div id="canvas-wrapper">
            <canvas id="drawing-canvas" width="800" height="550"></canvas>
        </div>
        <div style="text-align: center; margin-top: 10px;">
            <button id="undo-canvas-btn" class="logout-button" style="background-color: #ffc107; color: black;">Zp캩t</button>
            <button id="clear-canvas-btn" class="logout-button">Vymazat pl치tno</button>
        </div>
    </div>
</div>

{{ room_name|json_script:"room-name-json" }}
{{ canvas_content|default_if_none:"null"|json_script:"canvas-content-json" }}
{{ user.username|json_script:"current-user-json" }}

<script>
    // --- Z츼KLADN칈 PROM캨NN칄 ---
    const roomName = JSON.parse(document.getElementById('room-name-json').textContent);
    const currentUsername = JSON.parse(document.getElementById('current-user-json').textContent);
    const initialCanvasContent = JSON.parse(document.getElementById('canvas-content-json').textContent);
    
    // Elementy str치nky
    const chatLog = document.querySelector('#chat-log');
    const messageInput = document.querySelector('#chat-message-input');
    const canvas = document.getElementById('drawing-canvas');
    const context = canvas.getContext('2d');

    // WebSocket p콏ipojen칤
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(
        protocol + window.location.host + '/ws/chat/' + roomName + '/'
    );

    // --- LOGIKA PRO TEXTOV칗 CHAT ---
    messageInput.focus();
    document.querySelector('#chat-message-submit').onclick = function(e) {
        if (messageInput.value.trim() !== '') {
            chatSocket.send(JSON.stringify({'type': 'chat_message', 'message': messageInput.value}));
            messageInput.value = '';
        }
    };
    messageInput.onkeyup = function(e) {
        if (e.key === 'Enter') { document.querySelector('#chat-message-submit').click(); }
    };

    // --- LOGIKA PRO INDIK츼TOR PSAN칈 ---
    let typingTimer;
    messageInput.addEventListener('input', () => {
        clearTimeout(typingTimer);
        // Po코le sign치l, 쬰 u쬴vatel za캜al ps치t
        chatSocket.send(JSON.stringify({'type': 'typing_started'}));
    });

    // --- LOGIKA PRO P콎EP칈N츼N칈 POHLED콡 ---
    const showChatBtn = document.getElementById('show-chat-btn');
    const showCanvasBtn = document.getElementById('show-canvas-btn');
    const chatView = document.getElementById('chat-view');
    const canvasView = document.getElementById('canvas-view');

    showChatBtn.addEventListener('click', () => {
        chatView.style.display = 'block';
        canvasView.style.display = 'none';
        showChatBtn.classList.add('active');
        showCanvasBtn.classList.remove('active');
    });
    showCanvasBtn.addEventListener('click', () => {
        canvasView.style.display = 'block';
        chatView.style.display = 'none';
        showCanvasBtn.classList.add('active');
        showChatBtn.classList.remove('active');
    });
    canvasView.style.display = 'none';

    // --- LOGIKA PRO KRESLEN칈 NA PL츼TNO ---
    let isDrawing = false, lastX = 0, lastY = 0;
    let history = [], historyStep = -1;

    function saveHistory() {
        if (historyStep < history.length - 1) { history.splice(historyStep + 1); }
        history.push(canvas.toDataURL());
        historyStep++;
    }
    
    if (initialCanvasContent) {
        const image = new Image();
        image.onload = () => { context.drawImage(image, 0, 0); saveHistory(); };
        image.src = initialCanvasContent;
    } else { saveHistory(); }

    function draw(x, y, prevX, prevY) {
        context.strokeStyle = '#000000'; context.lineWidth = 3;
        context.lineJoin = 'round'; context.lineCap = 'round';
        context.beginPath(); context.moveTo(prevX, prevY);
        context.lineTo(x, y); context.stroke();
    }

    function saveCanvasState() {
        const dataURL = canvas.toDataURL();
        const csrftoken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        fetch(`/save-canvas/${roomName}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/json'},
            body: JSON.stringify({'content': dataURL})
        });
    }

    canvas.addEventListener('mousedown', (e) => { isDrawing = true; [lastX, lastY] = [e.offsetX, e.offsetY]; });
    canvas.addEventListener('mouseup', () => { if (isDrawing) { isDrawing = false; saveHistory(); saveCanvasState(); } });
    canvas.addEventListener('mouseout', () => { if (isDrawing) { isDrawing = false; saveCanvasState(); } });
    canvas.addEventListener('mousemove', (e) => {
        if (isDrawing) {
            draw(e.offsetX, e.offsetY, lastX, lastY);
            chatSocket.send(JSON.stringify({'type': 'drawing', 'x': e.offsetX, 'y': e.offsetY, 'lastX': lastX, 'lastY': lastY}));
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }
    });

    document.getElementById('clear-canvas-btn').addEventListener('click', () => {
        context.clearRect(0, 0, canvas.width, canvas.height);
        saveHistory(); saveCanvasState();
        chatSocket.send(JSON.stringify({'type': 'clear_canvas'}));
    });
    
    document.getElementById('undo-canvas-btn').addEventListener('click', () => {
        if (historyStep > 0) {
            historyStep--;
            const image = new Image();
            image.onload = () => {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, 0, 0);
                saveCanvasState(); 
            };
            image.src = history[historyStep];
        }
    });

    // --- HLAVN칈 FUNKCE PRO ZPRACOV츼N칈 ZPR츼V Z WEBSOCKETU ---
    const typingUsers = new Map();
    const typingIndicator = document.getElementById('typing-indicator');

    chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    switch(data.type) {
        case 'chat_message':
            // P콏id치 novou textovou zpr치vu do chatu
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<span class="message-time">${data.timestamp}</span> <b>${data.username}</b>: <span>${data.message}</span>`;
            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;
            break;

        case 'user_list_update':
            // TOTO JE UPRAVEN츼 캛츼ST: Najde prvek v navigaci a aktualizuje po캜et
            const userCountSpan = document.getElementById('online-user-count');
            const userCount = data.users.length;
            
            if (userCountSpan) {
                userCountSpan.innerHTML = `游녻 ${userCount}`;
                userCountSpan.style.display = 'inline';
            }
            break;

        case 'typing_indicator':
            // Zobraz칤, kdo pr치v캩 p칤코e
            if (typingUsers.has(data.username)) {
                clearTimeout(typingUsers.get(data.username));
            }
            const timer = setTimeout(() => {
                typingUsers.delete(data.username);
                updateTypingIndicator();
            }, 2000); // Indik치tor zmiz칤 po 2 sekund치ch ne캜innosti
            typingUsers.set(data.username, timer);
            updateTypingIndicator();
            break;

        case 'drawing':
            // Vykresl칤 tah od jin칠ho u쬴vatele
            draw(data.x, data.y, data.lastX, data.lastY);
            break;
            
        case 'clear_canvas':
            // Vyma쬰 pl치tno na p콏칤kaz od jin칠ho u쬴vatele
            context.clearRect(0, 0, canvas.width, canvas.height);
            saveHistory();
            break;
        
        case 'force_redraw':
            // P콏ekresl칤 pl치tno na stav, kter칳 p콏i코el ze serveru (po "undo")
            const image = new Image();
            image.onload = function() {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(image, 0, 0);
            };
            image.src = data.content;
            break;
    }
};

    function updateTypingIndicator() {
        const users = Array.from(typingUsers.keys());
        if (users.length === 0) {
            typingIndicator.textContent = '';
        } else if (users.length === 1) {
            typingIndicator.textContent = `${users[0]} p칤코e...`;
        } else if (users.length > 3) {
            typingIndicator.textContent = 'V칤ce lid칤 p칤코e...';
        } else {
            typingIndicator.textContent = `${users.join(', ')} p칤코칤...`;
        }
    }
    
    chatLog.scrollTop = chatLog.scrollHeight;
</script>
{% endblock %}